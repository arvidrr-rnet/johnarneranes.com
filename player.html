<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAR — Spiller</title>
    <link rel="icon" href="images/icon/icon144.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --body-bg: #1a1a1a;
            --chassis: #2a2a2a;
            --chassis-edge: #3a3a3a;
            --chrome: #888;
            --chrome-light: #bbb;
            --lcd-bg: #0a1a0a;
            --lcd-text: #33ff66;
            --lcd-dim: #1a4a2a;
            --reel-bg: #222;
            --reel-hub: #444;
            --tape: #1a0a00;
            --tape-window: #0d0800;
            --btn-face: #3a3a3a;
            --btn-edge: #555;
            --btn-active: #2a2a2a;
            --accent: #ff3344;
            --accent-dim: #661122;
            --vu-green: #33ff66;
            --vu-yellow: #ffdd33;
            --vu-red: #ff3344;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Share Tech Mono', monospace;
            background: var(--body-bg);
            color: #ccc;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            user-select: none;
        }

        /* ── KASSETTSPILLER CHASSIS ── */
        .deck {
            width: 420px;
            max-width: 96vw;
            background: var(--chassis);
            border-radius: 12px;
            border: 1px solid var(--chassis-edge);
            box-shadow:
                0 2px 0 #444,
                0 4px 0 #333,
                0 8px 20px rgba(0,0,0,0.6),
                inset 0 1px 0 rgba(255,255,255,0.05);
            overflow: hidden;
        }

        /* ── TOPPSEKSJON: MERKE ── */
        .deck__brand {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px 6px;
        }

        .deck__brand-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 4px;
            color: var(--chrome-light);
            text-transform: uppercase;
        }

        .deck__brand-model {
            font-size: 9px;
            letter-spacing: 2px;
            color: var(--chrome);
            text-transform: uppercase;
        }

        .deck__close {
            background: none;
            border: none;
            color: var(--chrome);
            cursor: pointer;
            font-size: 14px;
            padding: 2px 6px;
            border-radius: 2px;
            transition: color 0.2s;
        }
        .deck__close:hover { color: #fff; }

        /* ── LCD DISPLAY ── */
        .lcd {
            margin: 6px 14px;
            background: var(--lcd-bg);
            border: 2px solid #111;
            border-radius: 4px;
            padding: 8px 12px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.8);
            position: relative;
            overflow: hidden;
        }

        .lcd::before {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0,0,0,0.15) 2px,
                rgba(0,0,0,0.15) 4px
            );
            pointer-events: none;
        }

        .lcd__row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .lcd__title {
            font-family: 'Share Tech Mono', monospace;
            font-size: 14px;
            color: var(--lcd-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70%;
            text-shadow: 0 0 8px rgba(51,255,102,0.5);
        }

        .lcd__time {
            font-family: 'Share Tech Mono', monospace;
            font-size: 14px;
            color: var(--lcd-text);
            font-variant-numeric: tabular-nums;
            text-shadow: 0 0 8px rgba(51,255,102,0.5);
        }

        .lcd__artist {
            font-size: 10px;
            color: var(--lcd-dim);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lcd__status {
            font-size: 10px;
            color: var(--lcd-dim);
            text-align: right;
        }

        .lcd__status.playing {
            color: var(--lcd-text);
        }

        /* ── VU METER ── */
        .vu {
            display: flex;
            gap: 3px;
            margin: 6px 14px;
            height: 8px;
        }

        .vu__bar {
            flex: 1;
            height: 100%;
            background: var(--lcd-dim);
            border-radius: 1px;
            transition: background 0.08s;
        }

        .vu__bar.lit-green { background: var(--vu-green); box-shadow: 0 0 4px rgba(51,255,102,0.4); }
        .vu__bar.lit-yellow { background: var(--vu-yellow); box-shadow: 0 0 4px rgba(255,221,51,0.4); }
        .vu__bar.lit-red { background: var(--vu-red); box-shadow: 0 0 4px rgba(255,51,68,0.4); }

        /* ── KASSETTVINDU ── */
        .cassette-window {
            margin: 8px 14px;
            background: var(--tape-window);
            border: 2px solid #111;
            border-radius: 8px;
            padding: 12px 20px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            position: relative;
            cursor: pointer;
        }

        /* Tape mellom rullene */
        .cassette-window__tape {
            position: absolute;
            top: 50%;
            left: 60px;
            right: 60px;
            height: 6px;
            transform: translateY(-50%);
            background: #1a0800;
            border-top: 1px solid #2a1a08;
            border-bottom: 1px solid #0a0400;
        }

        /* Progress overlay på tapen */
        .cassette-window__progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(180,120,40,0.25);
            width: 0%;
            transition: width 0.2s linear;
        }

        /* Spoler */
        .reel {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--reel-bg);
            border: 2px solid #333;
            position: relative;
            z-index: 2;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.6);
            flex-shrink: 0;
        }

        .reel__hub {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 22px;
            height: 22px;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background: var(--reel-hub);
            border: 2px solid #555;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
        }

        .reel__spoke {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 28px;
            background: #333;
            transform-origin: center top;
        }

        .reel--left .reel__spoke:nth-child(1) { transform: translate(-50%, 0) rotate(0deg); }
        .reel--left .reel__spoke:nth-child(2) { transform: translate(-50%, 0) rotate(120deg); }
        .reel--left .reel__spoke:nth-child(3) { transform: translate(-50%, 0) rotate(240deg); }
        .reel--right .reel__spoke:nth-child(1) { transform: translate(-50%, 0) rotate(0deg); }
        .reel--right .reel__spoke:nth-child(2) { transform: translate(-50%, 0) rotate(120deg); }
        .reel--right .reel__spoke:nth-child(3) { transform: translate(-50%, 0) rotate(240deg); }

        /* Animasjon for spinnende spoler */
        .deck.playing .reel {
            animation: spin-reel 2s linear infinite;
        }

        .deck.playing .reel--left {
            animation-duration: 2.5s;
        }

        @keyframes spin-reel {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Tape-mengde rundt spolene (visuelt) */
        .reel::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            border-radius: 50%;
            background: radial-gradient(circle, transparent 40%, #1a0a00 41%, #2a1508 100%);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .reel--left::after {
            width: var(--tape-left, 58px);
            height: var(--tape-left, 58px);
        }

        .reel--right::after {
            width: var(--tape-right, 30px);
            height: var(--tape-right, 30px);
        }

        /* Spacer mellom spoler */
        .cassette-window__spacer {
            flex: 1;
        }

        /* Kassett-etikett */
        .cassette-window__label {
            position: absolute;
            bottom: 4px;
            font-size: 7px;
            letter-spacing: 2px;
            color: rgba(180,120,40,0.3);
            text-transform: uppercase;
        }

        /* ── TRANSPORT-KNAPPER ── */
        .transport {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 12px 14px;
        }

        .transport__btn {
            background: var(--btn-face);
            border: 1px solid var(--btn-edge);
            color: var(--chrome-light);
            cursor: pointer;
            font-size: 14px;
            padding: 10px 14px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
            box-shadow:
                0 2px 0 #222,
                0 3px 4px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.08);
            min-width: 44px;
        }

        .transport__btn:hover {
            background: #444;
            border-color: #666;
        }

        .transport__btn:active {
            background: var(--btn-active);
            box-shadow:
                0 0 0 #222,
                0 1px 2px rgba(0,0,0,0.3),
                inset 0 2px 4px rgba(0,0,0,0.3);
            transform: translateY(2px);
        }

        .transport__btn svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .transport__btn--play {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: #fff;
            padding: 12px 20px;
            min-width: 56px;
        }

        .transport__btn--play:hover {
            background: var(--accent);
        }

        .transport__btn--play:active {
            background: #991122;
        }

        .transport__btn--rec {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-dim);
            border: 2px solid var(--accent);
            min-width: 0;
            padding: 0;
            margin-left: 8px;
        }

        .deck.playing .transport__btn--rec {
            background: var(--accent);
            box-shadow: 0 0 8px rgba(255,51,68,0.5);
            animation: blink-rec 1.5s ease-in-out infinite;
        }

        @keyframes blink-rec {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* ── VOLUME OG EKSTRA ── */
        .deck__footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 14px 12px;
            gap: 12px;
        }

        .volume {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
        }

        .volume__label {
            font-size: 8px;
            letter-spacing: 2px;
            color: var(--chrome);
            text-transform: uppercase;
        }

        .volume__slider {
            flex: 1;
            height: 3px;
            -webkit-appearance: none;
            appearance: none;
            background: #333;
            border-radius: 2px;
            outline: none;
            max-width: 120px;
        }

        .volume__slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--chrome);
            cursor: pointer;
            border: 2px solid #666;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .deck__lib-btn {
            background: var(--btn-face);
            border: 1px solid var(--btn-edge);
            color: var(--chrome);
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            font-size: 9px;
            letter-spacing: 1px;
            padding: 5px 10px;
            border-radius: 3px;
            text-transform: uppercase;
            transition: all 0.15s;
            box-shadow: 0 1px 0 #222;
        }

        .deck__lib-btn:hover { background: #444; color: #fff; }
        .deck__lib-btn.active { color: var(--lcd-text); border-color: var(--lcd-text); }

        /* ── BIBLIOTEK-PANEL ── */
        .library {
            display: none;
            max-height: 220px;
            overflow-y: auto;
            background: #1a1a1a;
            border-top: 1px solid #333;
        }

        .library.open { display: block; }

        .library::-webkit-scrollbar { width: 4px; }
        .library::-webkit-scrollbar-track { background: transparent; }
        .library::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }

        .library__category {
            padding: 6px 14px 3px;
            font-size: 8px;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--chrome);
            text-transform: uppercase;
            border-top: 1px solid #2a2a2a;
        }

        .library__category:first-child { border-top: none; }

        .library__album {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            cursor: pointer;
            border: none;
            background: none;
            color: #ccc;
            font-family: 'Share Tech Mono', monospace;
            font-size: 11px;
            text-align: left;
            width: 100%;
            transition: background 0.15s;
        }

        .library__album:hover { background: rgba(255,255,255,0.04); }
        .library__album.active { color: var(--lcd-text); }

        .library__album-cover {
            width: 28px;
            height: 28px;
            border-radius: 2px;
            object-fit: cover;
            background: #222;
            flex-shrink: 0;
        }

        .library__album-info { flex: 1; min-width: 0; }

        .library__album-title {
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .library__album-artist {
            font-size: 9px;
            color: var(--chrome);
        }

        .library__album-arrow {
            color: var(--chrome);
            font-size: 8px;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .library__album.expanded .library__album-arrow {
            transform: rotate(90deg);
        }

        .library__tracks {
            display: none;
            flex-direction: column;
            padding-left: 12px;
            background: rgba(0,0,0,0.3);
        }

        .library__tracks.open { display: flex; }

        .library__track {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 14px;
            cursor: pointer;
            border: none;
            background: none;
            color: #aaa;
            font-family: 'Share Tech Mono', monospace;
            font-size: 10px;
            text-align: left;
            width: 100%;
            transition: background 0.15s;
        }

        .library__track:hover { background: rgba(255,255,255,0.04); }
        .library__track.playing { color: var(--lcd-text); }

        .library__track-num {
            color: var(--chrome);
            font-size: 9px;
            min-width: 14px;
            text-align: right;
        }

        .library__track.playing .library__track-num { color: var(--lcd-text); }
        .library__track-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .library__track-dur { color: var(--chrome); font-size: 9px; }

        /* ── COUNTER (tapeteller) ── */
        .counter {
            font-family: 'Orbitron', sans-serif;
            font-size: 10px;
            color: var(--chrome);
            letter-spacing: 2px;
            display: flex;
            gap: 12px;
        }

        .counter span { color: var(--chrome-light); }

        /* ── RESPONSIVE ── */
        @media (max-width: 440px) {
            .deck { border-radius: 0; }
            .reel { width: 50px; height: 50px; }
            .reel__hub { width: 18px; height: 18px; }
            .reel__spoke { height: 22px; }
            .reel--left::after { width: var(--tape-left, 44px); height: var(--tape-left, 44px); }
            .reel--right::after { width: var(--tape-right, 24px); height: var(--tape-right, 24px); }
            .cassette-window__tape { left: 45px; right: 45px; }
        }
    </style>
</head>
<body>

<div class="deck" id="deck">

    <!-- Merke -->
    <div class="deck__brand">
        <div>
            <div class="deck__brand-name">JAR</div>
            <div class="deck__brand-model">Stereo Cassette Deck</div>
        </div>
        <button class="deck__close" id="close-btn" title="Lukk">✕</button>
    </div>

    <!-- LCD Display -->
    <div class="lcd">
        <div class="lcd__row">
            <div class="lcd__title" id="title">INGEN KASSETT</div>
            <div class="lcd__time" id="current-time">0:00</div>
        </div>
        <div class="lcd__row">
            <div class="lcd__artist" id="artist">Sett inn kassett...</div>
            <div class="lcd__status" id="status">STOP</div>
        </div>
    </div>

    <!-- VU Meter -->
    <div class="vu" id="vu-meter">
        <div class="vu__bar"></div><div class="vu__bar"></div><div class="vu__bar"></div>
        <div class="vu__bar"></div><div class="vu__bar"></div><div class="vu__bar"></div>
        <div class="vu__bar"></div><div class="vu__bar"></div><div class="vu__bar"></div>
        <div class="vu__bar"></div><div class="vu__bar"></div><div class="vu__bar"></div>
        <div class="vu__bar"></div><div class="vu__bar"></div><div class="vu__bar"></div>
        <div class="vu__bar"></div><div class="vu__bar"></div><div class="vu__bar"></div>
        <div class="vu__bar"></div><div class="vu__bar"></div>
    </div>

    <!-- Kassettvindu med spoler -->
    <div class="cassette-window" id="cassette-window">
        <div class="cassette-window__tape">
            <div class="cassette-window__progress" id="progress-fill"></div>
        </div>
        <div class="reel reel--left" id="reel-left">
            <div class="reel__spoke"></div>
            <div class="reel__spoke"></div>
            <div class="reel__spoke"></div>
            <div class="reel__hub"></div>
        </div>
        <div class="cassette-window__spacer"></div>
        <div class="reel reel--right" id="reel-right">
            <div class="reel__spoke"></div>
            <div class="reel__spoke"></div>
            <div class="reel__spoke"></div>
            <div class="reel__hub"></div>
        </div>
        <span class="cassette-window__label">C-90 · Chrome</span>
    </div>

    <!-- Transport-knapper -->
    <div class="transport">
        <button class="transport__btn" id="prev-btn" title="Forrige (⏮)">
            <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"/></svg>
        </button>
        <button class="transport__btn transport__btn--play" id="play-btn" title="Spill / Pause">
            <svg viewBox="0 0 24 24" class="icon-play"><path d="M8 5v14l11-7z"/></svg>
            <svg viewBox="0 0 24 24" class="icon-pause" style="display:none"><path d="M6 19h4V5H6zm8-14v14h4V5z"/></svg>
        </button>
        <button class="transport__btn" id="stop-btn" title="Stopp (■)">
            <svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12"/></svg>
        </button>
        <button class="transport__btn" id="next-btn" title="Neste (⏭)">
            <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zm10-12v12h2V6z"/></svg>
        </button>
        <div class="transport__btn--rec" id="rec-led"></div>
    </div>

    <!-- Volum og bibliotek -->
    <div class="deck__footer">
        <div class="volume">
            <span class="volume__label">Vol</span>
            <input type="range" class="volume__slider" id="volume-slider" min="0" max="1" step="0.01" value="0.7">
        </div>
        <div class="counter">
            <span id="duration">0:00</span>
        </div>
        <button class="deck__lib-btn" id="list-btn">Kassetter</button>
    </div>

    <!-- Bibliotek -->
    <div class="library" id="library-panel"></div>

</div>

<script>
/**
 * Retro Cassette Deck Player
 * Pop-out spiller med kassettspiller-estetikk
 */
const AUDIO_BASE_URL = 'https://johnarneranes.com/';

class CassetteDeck {
    constructor() {
        this.audio = new Audio();
        this.channel = new BroadcastChannel('jar-player');
        this.currentPlaylist = [];
        this.currentIndex = 0;
        this.currentAlbum = null;
        this.isPlaying = false;
        this.library = null;
        this.pendingSeek = null;
        this.shouldAutoPlay = false;
        this.ready = false;
        this.analyser = null;
        this.audioCtx = null;

        this.cacheElements();
        this.bindEvents();
        this.startup();
    }

    cacheElements() {
        this.deck = document.getElementById('deck');
        this.titleEl = document.getElementById('title');
        this.artistEl = document.getElementById('artist');
        this.statusEl = document.getElementById('status');
        this.playBtn = document.getElementById('play-btn');
        this.prevBtn = document.getElementById('prev-btn');
        this.nextBtn = document.getElementById('next-btn');
        this.stopBtn = document.getElementById('stop-btn');
        this.progressFill = document.getElementById('progress-fill');
        this.currentTimeEl = document.getElementById('current-time');
        this.durationEl = document.getElementById('duration');
        this.volumeSlider = document.getElementById('volume-slider');
        this.closeBtn = document.getElementById('close-btn');
        this.listBtn = document.getElementById('list-btn');
        this.libraryPanel = document.getElementById('library-panel');
        this.reelLeft = document.getElementById('reel-left');
        this.reelRight = document.getElementById('reel-right');
        this.cassetteWindow = document.getElementById('cassette-window');
        this.vuMeter = document.getElementById('vu-meter');
        this.vuBars = this.vuMeter.querySelectorAll('.vu__bar');
    }

    bindEvents() {
        this.playBtn.addEventListener('click', () => this.togglePlay());
        this.prevBtn.addEventListener('click', () => this.previousTrack());
        this.nextBtn.addEventListener('click', () => this.nextTrack());
        this.stopBtn.addEventListener('click', () => this.stop());
        this.closeBtn.addEventListener('click', () => this.close());
        this.listBtn.addEventListener('click', () => this.toggleLibrary());

        this.cassetteWindow.addEventListener('click', (e) => {
            if (!this.audio.duration) return;
            var rect = this.cassetteWindow.getBoundingClientRect();
            var percent = (e.clientX - rect.left) / rect.width;
            this.audio.currentTime = percent * this.audio.duration;
        });

        this.volumeSlider.addEventListener('input', (e) => {
            this.audio.volume = parseFloat(e.target.value);
        });

        this.audio.addEventListener('timeupdate', () => this.updateProgress());
        this.audio.addEventListener('loadedmetadata', () => {
            this.updateDuration();
            if (this.pendingSeek !== null) {
                this.audio.currentTime = this.pendingSeek;
                this.pendingSeek = null;
            }
            if (this.shouldAutoPlay) {
                this.shouldAutoPlay = false;
                this.play();
            }
        });
        this.audio.addEventListener('ended', () => this.handleTrackEnd());
        this.audio.addEventListener('play', () => {
            this.isPlaying = true;
            this.deck.classList.add('playing');
            this.playBtn.querySelector('.icon-play').style.display = 'none';
            this.playBtn.querySelector('.icon-pause').style.display = '';
            this.statusEl.textContent = '▶ PLAY';
            this.statusEl.classList.add('playing');
            this.startVU();
        });
        this.audio.addEventListener('pause', () => {
            this.isPlaying = false;
            this.deck.classList.remove('playing');
            this.playBtn.querySelector('.icon-play').style.display = '';
            this.playBtn.querySelector('.icon-pause').style.display = 'none';
            this.statusEl.textContent = 'PAUSE';
            this.statusEl.classList.remove('playing');
            this.stopVU();
        });
        this.audio.addEventListener('error', (e) => {
            console.error('Audio feil:', this.audio.error?.message);
        });

        this.channel.onmessage = (e) => this.handleMessage(e);

        window.addEventListener('beforeunload', () => {
            this.saveState();
            this.channel.postMessage({ type: 'popout-closed', data: this.getState() });
        });

        document.addEventListener('keydown', (e) => {
            switch (e.code) {
                case 'Space':
                    e.preventDefault();
                    this.togglePlay();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    this.audio.currentTime = Math.max(0, this.audio.currentTime - 10);
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    this.audio.currentTime = Math.min(this.audio.duration || 0, this.audio.currentTime + 10);
                    break;
            }
        });
    }

    /* ── VU Meter med Web Audio API ── */
    initAudioContext() {
        if (this.audioCtx) return;
        try {
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            var source = this.audioCtx.createMediaElementSource(this.audio);
            this.analyser = this.audioCtx.createAnalyser();
            this.analyser.fftSize = 64;
            source.connect(this.analyser);
            this.analyser.connect(this.audioCtx.destination);
        } catch (e) {
            console.warn('Web Audio API ikke tilgjengelig:', e);
        }
    }

    startVU() {
        this.initAudioContext();
        if (!this.analyser) {
            // Fallback: simuler VU uten Web Audio
            this._vuInterval = setInterval(() => this.fakeVU(), 80);
            return;
        }
        this._vuFrame = requestAnimationFrame(() => this.drawVU());
    }

    stopVU() {
        if (this._vuInterval) clearInterval(this._vuInterval);
        if (this._vuFrame) cancelAnimationFrame(this._vuFrame);
        this.vuBars.forEach(bar => bar.className = 'vu__bar');
    }

    drawVU() {
        if (!this.isPlaying) return;
        var data = new Uint8Array(this.analyser.frequencyBinCount);
        this.analyser.getByteFrequencyData(data);

        // Gjennomsnittlig nivå
        var sum = 0;
        for (var i = 0; i < data.length; i++) sum += data[i];
        var avg = sum / data.length;
        var level = Math.floor((avg / 255) * this.vuBars.length);

        this.vuBars.forEach((bar, idx) => {
            bar.className = 'vu__bar';
            if (idx < level) {
                if (idx < 12) bar.classList.add('lit-green');
                else if (idx < 16) bar.classList.add('lit-yellow');
                else bar.classList.add('lit-red');
            }
        });

        this._vuFrame = requestAnimationFrame(() => this.drawVU());
    }

    fakeVU() {
        if (!this.isPlaying) return;
        var base = 6 + Math.floor(Math.random() * 8);
        this.vuBars.forEach((bar, idx) => {
            bar.className = 'vu__bar';
            if (idx < base) {
                if (idx < 12) bar.classList.add('lit-green');
                else if (idx < 16) bar.classList.add('lit-yellow');
                else bar.classList.add('lit-red');
            }
        });
    }

    /* ── Spillkontroll ── */
    handleMessage(event) {
        var msg = event.data;
        if (msg.type === 'sync-state') this.restoreState(msg.data);
    }

    async startup() {
        try {
            var resp = await fetch('data/music-library.json');
            this.library = await resp.json();
        } catch (e) {
            console.warn('Kunne ikke laste musikkbibliotek:', e);
        }

        var stateStr = localStorage.getItem('jar_playerState');
        if (stateStr) {
            try {
                var state = JSON.parse(stateStr);
                if (state && state.albumId) this.restoreState(state);
            } catch (e) { /* ignore */ }
        }

        this.ready = true;
        this.channel.postMessage({ type: 'popout-ready' });
    }

    restoreState(state) {
        if (!state) return;
        if (state.library) this.library = state.library;

        if (state.albumId && this.library?.albums) {
            this.currentAlbum = this.library.albums.find(a => a.id === state.albumId);
        }

        if (state.playlist && state.playlist.length > 0) {
            this.currentPlaylist = state.playlist;
        } else if (this.currentAlbum) {
            this.currentPlaylist = this.currentAlbum.tracks.map(t => ({
                ...t, artist: this.currentAlbum.artist, albumId: this.currentAlbum.id
            }));
        }

        this.currentIndex = state.trackIndex || 0;

        if (this.currentPlaylist[this.currentIndex]) {
            if (state.currentTime && state.currentTime > 0) this.pendingSeek = state.currentTime;
            if (state.isPlaying) this.shouldAutoPlay = true;
            this.loadTrack(this.currentPlaylist[this.currentIndex]);
        }

        if (state.volume !== undefined) {
            this.audio.volume = state.volume;
            this.volumeSlider.value = state.volume;
        }
    }

    loadTrack(track) {
        if (!track) return;
        var src = track.src.startsWith('http') ? track.src : AUDIO_BASE_URL + track.src;
        this.audio.src = src;
        this.audio.load();

        this.titleEl.textContent = (track.title || 'Ukjent spor').toUpperCase();
        this.artistEl.textContent = track.artist || '';
        document.title = track.title + ' — JAR Deck';
        this.updateLibraryHighlight();
    }

    play() {
        var p = this.audio.play();
        if (p) p.catch(function () {});
    }

    pause() {
        this.audio.pause();
    }

    stop() {
        this.audio.pause();
        this.audio.currentTime = 0;
        this.statusEl.textContent = 'STOP';
        this.statusEl.classList.remove('playing');
        this.deck.classList.remove('playing');
        this.stopVU();
    }

    togglePlay() {
        if (this.isPlaying) this.pause();
        else this.play();
    }

    previousTrack() {
        if (this.audio.currentTime > 3) { this.audio.currentTime = 0; return; }
        if (this.currentIndex > 0) {
            this.currentIndex--;
            this.loadTrack(this.currentPlaylist[this.currentIndex]);
            this.play();
        }
    }

    nextTrack() {
        if (this.currentIndex < this.currentPlaylist.length - 1) {
            this.currentIndex++;
            this.loadTrack(this.currentPlaylist[this.currentIndex]);
            this.play();
        }
    }

    handleTrackEnd() { this.nextTrack(); }

    updateProgress() {
        if (!this.audio.duration) return;
        var percent = (this.audio.currentTime / this.audio.duration) * 100;
        this.progressFill.style.width = percent + '%';
        this.currentTimeEl.textContent = this.formatTime(this.audio.currentTime);

        // Oppdater tape-mengde visuelt på spolene
        var p = percent / 100;
        var leftSize = 58 - (p * 28);
        var rightSize = 30 + (p * 28);
        this.reelLeft.style.setProperty('--tape-left', leftSize + 'px');
        this.reelRight.style.setProperty('--tape-right', rightSize + 'px');
    }

    updateDuration() {
        this.durationEl.textContent = this.formatTime(this.audio.duration);
    }

    formatTime(seconds) {
        if (isNaN(seconds)) return '0:00';
        var mins = Math.floor(seconds / 60);
        var secs = Math.floor(seconds % 60);
        return mins + ':' + secs.toString().padStart(2, '0');
    }

    /* ── Bibliotek ── */
    toggleLibrary() {
        var isOpen = this.libraryPanel.classList.toggle('open');
        this.listBtn.classList.toggle('active', isOpen);
        if (isOpen) this.renderLibrary();
    }

    renderLibrary() {
        if (!this.library?.albums?.length) {
            this.libraryPanel.innerHTML = '<div style="padding:16px;color:#666;font-size:11px;text-align:center">Ingen kassetter tilgjengelig</div>';
            return;
        }

        var categories = {};
        this.library.albums.forEach(function (album) {
            var cat = album.category || 'Annet';
            if (!categories[cat]) categories[cat] = [];
            categories[cat].push(album);
        });

        var self = this;
        var html = '';
        for (var cat in categories) {
            html += '<div class="library__category">' + cat + '</div>';
            categories[cat].forEach(function (album) {
                var isActive = self.currentAlbum?.id === album.id;
                var isExpanded = isActive;
                html += '<button class="library__album' + (isActive ? ' active' : '') + (isExpanded ? ' expanded' : '') + '" data-album-id="' + album.id + '">' +
                    '<img class="library__album-cover" src="' + album.cover + '" onerror="this.src=\'images/icon/record.svg\'" alt="">' +
                    '<div class="library__album-info">' +
                        '<div class="library__album-title">' + album.title + '</div>' +
                        '<div class="library__album-artist">' + album.artist + '</div>' +
                    '</div>' +
                    '<span class="library__album-arrow">▶</span>' +
                '</button>';
                html += '<div class="library__tracks' + (isExpanded ? ' open' : '') + '" data-tracks-for="' + album.id + '">';
                album.tracks.forEach(function (track, i) {
                    var isPlaying = isActive && i === self.currentIndex;
                    var num = String(i + 1).padStart(2, '0');
                    html += '<button class="library__track' + (isPlaying ? ' playing' : '') + '" data-album-id="' + album.id + '" data-track-index="' + i + '">' +
                        '<span class="library__track-num">' + (isPlaying ? '♪' : num) + '</span>' +
                        '<span class="library__track-name">' + track.title + '</span>' +
                        '<span class="library__track-dur">' + (track.duration || '') + '</span>' +
                    '</button>';
                });
                html += '</div>';
            });
        }

        this.libraryPanel.innerHTML = html;

        this.libraryPanel.querySelectorAll('.library__album').forEach(function (btn) {
            btn.addEventListener('click', function () {
                var albumId = btn.dataset.albumId;
                var tracksDiv = self.libraryPanel.querySelector('[data-tracks-for="' + albumId + '"]');
                var wasExpanded = btn.classList.contains('expanded');

                self.libraryPanel.querySelectorAll('.library__album.expanded').forEach(function (el) { el.classList.remove('expanded'); });
                self.libraryPanel.querySelectorAll('.library__tracks.open').forEach(function (el) { el.classList.remove('open'); });

                if (!wasExpanded) {
                    btn.classList.add('expanded');
                    tracksDiv.classList.add('open');
                }
            });
        });

        this.libraryPanel.querySelectorAll('.library__track').forEach(function (btn) {
            btn.addEventListener('click', function (e) {
                e.stopPropagation();
                self.selectAlbumTrack(btn.dataset.albumId, parseInt(btn.dataset.trackIndex));
            });
        });
    }

    selectAlbumTrack(albumId, trackIndex) {
        var album = this.library.albums.find(function (a) { return a.id === albumId; });
        if (!album) return;
        this.currentAlbum = album;
        this.currentPlaylist = album.tracks.map(function (t) {
            return { ...t, artist: album.artist, albumId: album.id };
        });
        this.currentIndex = trackIndex;
        this.loadTrack(this.currentPlaylist[this.currentIndex]);
        this.play();
    }

    updateLibraryHighlight() {
        if (this.libraryPanel.classList.contains('open')) this.renderLibrary();
    }

    getState() {
        return {
            albumId: this.currentAlbum?.id,
            trackIndex: this.currentIndex,
            currentTime: this.audio.currentTime,
            isPlaying: this.isPlaying,
            volume: this.audio.volume,
            playlist: this.currentPlaylist,
            timestamp: Date.now()
        };
    }

    saveState() {
        localStorage.setItem('jar_playerState', JSON.stringify(this.getState()));
    }

    close() {
        this.saveState();
        this.channel.postMessage({ type: 'popout-closed', data: this.getState() });
        window.close();
    }
}

new CassetteDeck();
</script>
</body>
</html>
