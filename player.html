<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAR — Spiller</title>
    <link rel="icon" href="images/icon/icon144.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0a;
            --bg-secondary: #141414;
            --text: #e8e6e3;
            --text-muted: #888;
            --accent: #c9a962;
            --accent-hover: #d4b66a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-app-region: drag;
        }

        .popout-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 11px;
            color: var(--text-muted);
            -webkit-app-region: drag;
        }

        .popout-header__title {
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .popout-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 16px;
            padding: 2px 6px;
            border-radius: 4px;
            -webkit-app-region: no-drag;
            transition: color 0.2s, background 0.2s;
        }

        .popout-close:hover {
            color: var(--text);
            background: rgba(255,255,255,0.1);
        }

        .popout-player {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px;
            gap: 12px;
            -webkit-app-region: no-drag;
        }

        .popout-track {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .popout-cover {
            width: 56px;
            height: 56px;
            border-radius: 6px;
            object-fit: cover;
            background: var(--bg-secondary);
            flex-shrink: 0;
        }

        .popout-info {
            flex: 1;
            min-width: 0;
        }

        .popout-title {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .popout-artist {
            font-size: 12px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .popout-progress {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .popout-time {
            font-size: 11px;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
            min-width: 35px;
        }

        .popout-time--end {
            text-align: right;
        }

        .popout-progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .popout-progress-bar:hover {
            height: 6px;
        }

        .popout-progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .popout-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .popout-btn {
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            font-size: 18px;
            padding: 6px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s, background 0.2s;
            width: 36px;
            height: 36px;
        }

        .popout-btn:hover {
            color: var(--accent);
            background: rgba(255,255,255,0.05);
        }

        .popout-btn--play {
            width: 48px;
            height: 48px;
            background: var(--accent);
            color: var(--bg);
        }

        .popout-btn--play svg {
            width: 22px;
            height: 22px;
            fill: var(--bg);
        }

        .popout-btn--play:hover {
            background: var(--accent-hover);
            color: var(--bg);
        }

        .popout-btn svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .popout-volume {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 4px;
        }

        .popout-volume-slider {
            flex: 1;
            height: 3px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            outline: none;
        }

        .popout-volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }

        .popout-no-track {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        /* Sporliste-knapp */
        .popout-btn--list {
            position: absolute;
            right: 16px;
        }

        .popout-btn--list.active {
            color: var(--accent);
        }

        .popout-controls {
            position: relative;
        }

        /* Bibliotek-panel (album + spor) */
        .popout-library {
            display: none;
            flex-direction: column;
            gap: 0;
            max-height: 300px;
            overflow-y: auto;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 4px 0;
            margin-top: -4px;
        }

        .popout-library.open {
            display: flex;
        }

        .popout-library::-webkit-scrollbar {
            width: 4px;
        }
        .popout-library::-webkit-scrollbar-track {
            background: transparent;
        }
        .popout-library::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.15);
            border-radius: 2px;
        }

        /* Album-header i listen */
        .popout-library__album {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.15s;
            border: none;
            background: none;
            color: var(--text);
            font-family: inherit;
            font-size: 12px;
            text-align: left;
            width: 100%;
        }

        .popout-library__album:hover {
            background: rgba(255,255,255,0.05);
        }

        .popout-library__album.active {
            background: rgba(201, 169, 98, 0.08);
        }

        .popout-library__album-cover {
            width: 36px;
            height: 36px;
            border-radius: 4px;
            object-fit: cover;
            background: var(--bg);
            flex-shrink: 0;
        }

        .popout-library__album-info {
            flex: 1;
            min-width: 0;
        }

        .popout-library__album-title {
            font-weight: 600;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .popout-library__album.active .popout-library__album-title {
            color: var(--accent);
        }

        .popout-library__album-artist {
            font-size: 11px;
            color: var(--text-muted);
        }

        .popout-library__album-arrow {
            color: var(--text-muted);
            font-size: 10px;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .popout-library__album.expanded .popout-library__album-arrow {
            transform: rotate(90deg);
        }

        /* Sporliste under album */
        .popout-library__tracks {
            display: none;
            flex-direction: column;
            padding-left: 16px;
            background: rgba(0,0,0,0.2);
        }

        .popout-library__tracks.open {
            display: flex;
        }

        .popout-library__track {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            cursor: pointer;
            transition: background 0.15s;
            border: none;
            background: none;
            color: var(--text);
            font-family: inherit;
            font-size: 11px;
            text-align: left;
            width: 100%;
        }

        .popout-library__track:hover {
            background: rgba(255,255,255,0.05);
        }

        .popout-library__track.playing {
            color: var(--accent);
        }

        .popout-library__track-num {
            color: var(--text-muted);
            font-size: 10px;
            min-width: 16px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .popout-library__track.playing .popout-library__track-num {
            color: var(--accent);
        }

        .popout-library__track-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .popout-library__track-dur {
            color: var(--text-muted);
            font-size: 10px;
            font-variant-numeric: tabular-nums;
        }

        /* Kategori-separator */
        .popout-library__category {
            padding: 8px 12px 4px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .popout-library__category:first-child {
            border-top: none;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.7; }
        }
    </style>
</head>
<body>
    <div class="popout-header">
        <span class="popout-header__title">JAR Spiller</span>
        <button class="popout-close" id="close-btn" title="Lukk">✕</button>
    </div>

    <div class="popout-player" id="player">
        <div class="popout-track">
            <img class="popout-cover" id="cover" src="images/icon/record.svg" alt="Plate-ikon">
            <div class="popout-info">
                <div class="popout-title" id="title">Ingen spor valgt</div>
                <div class="popout-artist" id="artist"></div>
            </div>
        </div>

        <div class="popout-progress">
            <span class="popout-time" id="current-time">0:00</span>
            <div class="popout-progress-bar" id="progress-bar">
                <div class="popout-progress-fill" id="progress-fill"></div>
            </div>
            <span class="popout-time popout-time--end" id="duration">0:00</span>
        </div>

        <div class="popout-controls">
            <button class="popout-btn" id="prev-btn" title="Forrige">
                <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"/></svg>
            </button>
            <button class="popout-btn popout-btn--play" id="play-btn" title="Spill/Pause">
                <svg viewBox="0 0 24 24" class="icon-play"><path d="M8 5v14l11-7z"/></svg>
                <svg viewBox="0 0 24 24" class="icon-pause" style="display:none"><path d="M6 19h4V5H6zm8-14v14h4V5z"/></svg>
            </button>
            <button class="popout-btn" id="next-btn" title="Neste">
                <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zm10-12v12h2V6z"/></svg>
            </button>
            <button class="popout-btn popout-btn--list" id="list-btn" title="Bibliotek">
                <svg viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H8V4h12v12z"/></svg>
            </button>
        </div>

        <div class="popout-library" id="library-panel"></div>

        <div class="popout-volume">
            <svg style="width:16px;height:16px;fill:var(--text-muted);flex-shrink:0" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
            <input type="range" class="popout-volume-slider" id="volume-slider" min="0" max="1" step="0.01" value="0.7">
        </div>
    </div>

    <script>
    /**
     * Pop-out Mini Player
     * Selvstendig lydspiller som kommuniserer med hovedvinduet via BroadcastChannel
     */
    const AUDIO_BASE_URL = 'https://johnarneranes.com/';

    class PopOutPlayer {
        constructor() {
            this.audio = new Audio();
            this.channel = new BroadcastChannel('jar-player');
            this.currentPlaylist = [];
            this.currentIndex = 0;
            this.currentAlbum = null;
            this.isPlaying = false;
            this.library = null;
            this.pendingSeek = null;
            this.shouldAutoPlay = false;
            this.ready = false;

            this.cacheElements();
            this.bindEvents();
            this.startup();
        }

        cacheElements() {
            this.coverEl = document.getElementById('cover');
            this.titleEl = document.getElementById('title');
            this.artistEl = document.getElementById('artist');
            this.playBtn = document.getElementById('play-btn');
            this.prevBtn = document.getElementById('prev-btn');
            this.nextBtn = document.getElementById('next-btn');
            this.progressBar = document.getElementById('progress-bar');
            this.progressFill = document.getElementById('progress-fill');
            this.currentTimeEl = document.getElementById('current-time');
            this.durationEl = document.getElementById('duration');
            this.volumeSlider = document.getElementById('volume-slider');
            this.closeBtn = document.getElementById('close-btn');
            this.listBtn = document.getElementById('list-btn');
            this.libraryPanel = document.getElementById('library-panel');
        }

        bindEvents() {
            this.playBtn.addEventListener('click', () => this.togglePlay());
            this.prevBtn.addEventListener('click', () => this.previousTrack());
            this.nextBtn.addEventListener('click', () => this.nextTrack());
            this.closeBtn.addEventListener('click', () => this.close());
            this.listBtn.addEventListener('click', () => this.toggleLibrary());

            this.progressBar.addEventListener('click', (e) => {
                if (!this.audio.duration) return;
                const rect = this.progressBar.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                this.audio.currentTime = percent * this.audio.duration;
            });

            this.volumeSlider.addEventListener('input', (e) => {
                this.audio.volume = parseFloat(e.target.value);
            });

            this.audio.addEventListener('timeupdate', () => this.updateProgress());
            this.audio.addEventListener('loadedmetadata', () => {
                this.updateDuration();
                // Sett currentTime etter at metadata er lastet
                if (this.pendingSeek !== null) {
                    this.audio.currentTime = this.pendingSeek;
                    this.pendingSeek = null;
                }
                // Autoplay etter metadata er klar
                if (this.shouldAutoPlay) {
                    this.shouldAutoPlay = false;
                    this.play();
                }
            });
            this.audio.addEventListener('ended', () => this.handleTrackEnd());
            this.audio.addEventListener('play', () => {
                this.isPlaying = true;
                this.playBtn.querySelector('.icon-play').style.display = 'none';
                this.playBtn.querySelector('.icon-pause').style.display = '';
            });
            this.audio.addEventListener('pause', () => {
                this.isPlaying = false;
                this.playBtn.querySelector('.icon-play').style.display = '';
                this.playBtn.querySelector('.icon-pause').style.display = 'none';
            });
            this.audio.addEventListener('error', (e) => {
                console.error('Audio feil:', this.audio.error?.message, 'src:', this.audio.src);
            });

            // Meldinger fra hovedvinduet
            this.channel.onmessage = (e) => this.handleMessage(e);

            // Lagre tilstand ved lukking
            window.addEventListener('beforeunload', () => {
                this.saveState();
                this.channel.postMessage({
                    type: 'popout-closed',
                    data: this.getState()
                });
            });

            // Tastaturkontroller
            document.addEventListener('keydown', (e) => {
                switch (e.code) {
                    case 'Space':
                        e.preventDefault();
                        this.togglePlay();
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        this.audio.currentTime = Math.max(0, this.audio.currentTime - 10);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        this.audio.currentTime = Math.min(this.audio.duration || 0, this.audio.currentTime + 10);
                        break;
                }
            });
        }

        handleMessage(event) {
            const { type, data } = event.data;
            switch (type) {
                case 'sync-state':
                    console.log('Mottok sync-state fra hovedvindu:', data);
                    this.restoreState(data);
                    break;
            }
        }

        async startup() {
            // Last musikkbibliotek først
            try {
                const resp = await fetch('data/music-library.json');
                const lib = await resp.json();
                this.library = lib;
            } catch (e) {
                console.warn('Kunne ikke laste musikkbibliotek:', e);
            }

            // Les tilstand fra localStorage
            const stateStr = localStorage.getItem('jar_playerState');
            if (stateStr) {
                try {
                    const state = JSON.parse(stateStr);
                    if (state && state.albumId) {
                        this.restoreState(state);
                    }
                } catch (e) {
                    console.warn('Kunne ikke gjenopprette tilstand:', e);
                }
            }

            this.ready = true;
            console.log('Pop-out klar, sender popout-ready');
            // Fortell hovedvinduet at pop-out er klart
            this.channel.postMessage({ type: 'popout-ready' });
        }

        restoreState(state) {
            if (!state) return;
            console.log('Gjenoppretter tilstand:', state.albumId, 'spor:', state.trackIndex);

            if (state.library) {
                this.library = state.library;
            }

            // Finn album
            if (state.albumId) {
                if (this.library?.albums) {
                    this.currentAlbum = this.library.albums.find(a => a.id === state.albumId);
                }
            }

            // Sett playlist
            if (state.playlist && state.playlist.length > 0) {
                this.currentPlaylist = state.playlist;
            } else if (this.currentAlbum) {
                this.currentPlaylist = this.currentAlbum.tracks.map(t => ({
                    ...t,
                    artist: this.currentAlbum.artist,
                    albumId: this.currentAlbum.id
                }));
            }

            this.currentIndex = state.trackIndex || 0;

            if (this.currentPlaylist[this.currentIndex]) {
                // Sett opp seek og autoplay FØR loadTrack
                if (state.currentTime && state.currentTime > 0) {
                    this.pendingSeek = state.currentTime;
                }
                if (state.isPlaying) {
                    this.shouldAutoPlay = true;
                }

                this.loadTrack(this.currentPlaylist[this.currentIndex]);
            }

            if (state.volume !== undefined) {
                this.audio.volume = state.volume;
                this.volumeSlider.value = state.volume;
            }
        }

        loadTrack(track) {
            if (!track) return;

            const src = track.src.startsWith('http') ? track.src : AUDIO_BASE_URL + track.src;
            console.log('Laster spor:', track.title, 'fra:', src);
            this.audio.src = src;
            this.audio.load();

            this.titleEl.textContent = track.title || 'Ukjent spor';
            this.artistEl.textContent = track.artist || '';

            // Albumcover
            if (this.currentAlbum?.cover) {
                this.coverEl.src = this.currentAlbum.cover;
                this.coverEl.onerror = () => {
                    this.coverEl.src = 'images/icon/record.svg';
                };
            } else {
                this.coverEl.src = 'images/icon/record.svg';
            }

            document.title = `${track.title} — JAR`;
            this.updateLibraryHighlight();
        }

        toggleLibrary() {
            const isOpen = this.libraryPanel.classList.toggle('open');
            this.listBtn.classList.toggle('active', isOpen);
            if (isOpen) {
                this.renderLibrary();
            }
        }

        renderLibrary() {
            if (!this.library?.albums?.length) {
                this.libraryPanel.innerHTML = '<div style="padding:16px;color:var(--text-muted);font-size:12px;text-align:center">Ingen album tilgjengelig</div>';
                return;
            }

            // Grupper album etter kategori
            const categories = {};
            this.library.albums.forEach(album => {
                const cat = album.category || 'Annet';
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push(album);
            });

            let html = '';
            for (const [cat, albums] of Object.entries(categories)) {
                html += `<div class="popout-library__category">${cat}</div>`;
                albums.forEach(album => {
                    const isActive = this.currentAlbum?.id === album.id;
                    const isExpanded = isActive;
                    html += `<button class="popout-library__album${isActive ? ' active' : ''}${isExpanded ? ' expanded' : ''}" data-album-id="${album.id}">
                        <img class="popout-library__album-cover" src="${album.cover}" onerror="this.src='images/icon/record.svg'" alt="Albumcover">
                        <div class="popout-library__album-info">
                            <div class="popout-library__album-title">${album.title}</div>
                            <div class="popout-library__album-artist">${album.artist} · ${album.year || ''}</div>
                        </div>
                        <span class="popout-library__album-arrow">▶</span>
                    </button>`;
                    html += `<div class="popout-library__tracks${isExpanded ? ' open' : ''}" data-tracks-for="${album.id}">`;
                    album.tracks.forEach((track, i) => {
                        const isPlaying = isActive && i === this.currentIndex;
                        const num = String(i + 1).padStart(2, '0');
                        html += `<button class="popout-library__track${isPlaying ? ' playing' : ''}" data-album-id="${album.id}" data-track-index="${i}">
                            <span class="popout-library__track-num">${isPlaying ? '♪' : num}</span>
                            <span class="popout-library__track-name">${track.title}</span>
                            <span class="popout-library__track-dur">${track.duration || ''}</span>
                        </button>`;
                    });
                    html += '</div>';
                });
            }

            this.libraryPanel.innerHTML = html;

            // Bind album-klikk (vis/skjul spor)
            this.libraryPanel.querySelectorAll('.popout-library__album').forEach(btn => {
                btn.addEventListener('click', () => {
                    const albumId = btn.dataset.albumId;
                    const tracksDiv = this.libraryPanel.querySelector(`[data-tracks-for="${albumId}"]`);
                    const wasExpanded = btn.classList.contains('expanded');

                    // Lukk alle andre
                    this.libraryPanel.querySelectorAll('.popout-library__album.expanded').forEach(el => el.classList.remove('expanded'));
                    this.libraryPanel.querySelectorAll('.popout-library__tracks.open').forEach(el => el.classList.remove('open'));

                    if (!wasExpanded) {
                        btn.classList.add('expanded');
                        tracksDiv.classList.add('open');
                    }
                });
            });

            // Bind spor-klikk
            this.libraryPanel.querySelectorAll('.popout-library__track').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const albumId = btn.dataset.albumId;
                    const trackIdx = parseInt(btn.dataset.trackIndex);
                    this.selectAlbumTrack(albumId, trackIdx);
                });
            });

            // Scroll aktivt album synlig
            const activeAlbum = this.libraryPanel.querySelector('.popout-library__album.active');
            if (activeAlbum) activeAlbum.scrollIntoView({ block: 'nearest' });
        }

        selectAlbumTrack(albumId, trackIndex) {
            const album = this.library.albums.find(a => a.id === albumId);
            if (!album) return;

            this.currentAlbum = album;
            this.currentPlaylist = album.tracks.map(t => ({
                ...t,
                artist: album.artist,
                albumId: album.id
            }));
            this.currentIndex = trackIndex;
            this.loadTrack(this.currentPlaylist[this.currentIndex]);
            this.play();
        }

        updateLibraryHighlight() {
            if (!this.libraryPanel.classList.contains('open')) return;
            // Re-render for å oppdatere highlight
            this.renderLibrary();
        }

        play() {
            const p = this.audio.play();
            if (p) {
                p.catch(err => {
                    console.warn('Autoplay blokkert:', err.message);
                    // Vis visuell hint om at brukeren må trykke play
                    this.playBtn.style.animation = 'pulse 1s ease-in-out 3';
                });
            }
        }

        pause() {
            this.audio.pause();
        }

        togglePlay() {
            this.playBtn.style.animation = '';
            if (this.isPlaying) {
                this.pause();
            } else {
                this.play();
            }
        }

        previousTrack() {
            if (this.audio.currentTime > 3) {
                this.audio.currentTime = 0;
                return;
            }
            if (this.currentIndex > 0) {
                this.currentIndex--;
                this.loadTrack(this.currentPlaylist[this.currentIndex]);
                this.play();
            }
        }

        nextTrack() {
            if (this.currentIndex < this.currentPlaylist.length - 1) {
                this.currentIndex++;
                this.loadTrack(this.currentPlaylist[this.currentIndex]);
                this.play();
            }
        }

        handleTrackEnd() {
            this.nextTrack();
        }

        updateProgress() {
            if (!this.audio.duration) return;
            const percent = (this.audio.currentTime / this.audio.duration) * 100;
            this.progressFill.style.width = `${percent}%`;
            this.currentTimeEl.textContent = this.formatTime(this.audio.currentTime);
        }

        updateDuration() {
            this.durationEl.textContent = this.formatTime(this.audio.duration);
        }

        formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        getState() {
            return {
                albumId: this.currentAlbum?.id,
                trackIndex: this.currentIndex,
                currentTime: this.audio.currentTime,
                isPlaying: this.isPlaying,
                volume: this.audio.volume,
                playlist: this.currentPlaylist,
                timestamp: Date.now()
            };
        }

        saveState() {
            const state = this.getState();
            localStorage.setItem('jar_playerState', JSON.stringify(state));
        }

        close() {
            this.saveState();
            this.channel.postMessage({
                type: 'popout-closed',
                data: this.getState()
            });
            window.close();
        }
    }

    // Start pop-out spiller
    new PopOutPlayer();
    </script>
</body>
</html>
